#!/bin/bash
# Push Chain Validator Control Script

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Source common functions if available (we're outside container)
if [ -f "$SCRIPT_DIR/scripts/common.sh" ]; then
    source "$SCRIPT_DIR/scripts/common.sh"
else
    # Define colors locally if common.sh not available
    GREEN='\033[0;32m'
    BLUE='\033[0;34m'
    RED='\033[0;31m'
    YELLOW='\033[0;33m'
    NC='\033[0m'
    
    # Define local versions of print functions
    print_status() {
        echo -e "${BLUE}$1${NC}"
    }
    
    print_success() {
        echo -e "${GREEN}$1${NC}"
    }
    
    print_error() {
        echo -e "${RED}$1${NC}"
    }
    
    print_warning() {
        echo -e "${YELLOW}$1${NC}"
    }
fi

# Load environment
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# Docker compose command (support both old and new versions)
if docker compose version &> /dev/null; then
    DOCKER_COMPOSE="docker compose"
else
    DOCKER_COMPOSE="docker-compose"
fi


# Main commands
case "$1" in
    start)
        print_status "üöÄ Starting Push Chain Validator..."
        
        # Check for --clean flag first
        if [[ "$2" == "--clean" ]]; then
            print_warning "üßπ Clean start requested - removing all blockchain data..."
            # Stop if running
            if $DOCKER_COMPOSE ps | grep -q "push-validator.*Up"; then
                print_status "üõë Stopping running validator..."
                $DOCKER_COMPOSE down -v
            else
                $DOCKER_COMPOSE down -v
            fi
            
            # Also remove host data directory
            if [ -d "./data" ]; then
                print_status "üóëÔ∏è  Removing host data directory..."
                rm -rf ./data
            fi
            
            print_success "‚úÖ All data cleaned"
        else
            # Check if already running (only for normal start)
            if $DOCKER_COMPOSE ps | grep -q "push-validator.*Up"; then
                print_warning "‚ö†Ô∏è  Validator is already running!"
                exit 0
            fi
        fi
        
        # Build image if needed
        if ! docker images | grep -q "push-validator.*local"; then
            print_status "üî® Building validator image..."
            $DOCKER_COMPOSE build
        fi
        
        # Start services
        $DOCKER_COMPOSE up -d
        
        # Check for AppHash errors in first 10 seconds
        print_status "üîç Checking for sync issues..."
        sleep 5
        
        if $DOCKER_COMPOSE logs --tail=50 2>&1 | grep -q "wrong Block.Header.AppHash"; then
            print_error "‚ùå AppHash mismatch detected - blockchain data incompatible with genesis"
            echo ""
            echo "This usually happens when:"
            echo "1. Genesis file was updated"
            echo "2. Switching between networks"
            echo "3. Blockchain data is corrupted"
            echo ""
            read -p "Would you like to clean data and restart? (yes/no): " -r
            if [[ $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
                print_status "üßπ Cleaning blockchain data..."
                $DOCKER_COMPOSE down -v
                print_status "üöÄ Starting fresh..."
                $DOCKER_COMPOSE up -d
                print_success "‚úÖ Validator restarted with clean data!"
            else
                print_warning "‚ö†Ô∏è  Validator may not sync properly without cleaning data"
            fi
        else
            print_success "‚úÖ Validator started successfully!"
        fi
        
        echo ""
        echo "Check status with: ./push-validator status"
        echo "View logs with: ./push-validator logs"
        ;;
        
    stop)
        print_status "üõë Stopping validator..."
        $DOCKER_COMPOSE down
        print_success "‚úÖ Validator stopped"
        ;;
        
    restart)
        print_status "üîÑ Restarting validator..."
        $DOCKER_COMPOSE restart
        print_success "‚úÖ Validator restarted"
        ;;
        
    status)
        print_status "üìä Validator Status"
        echo "=================="
        
        # Check if container is running
        if ! $DOCKER_COMPOSE ps | grep -q "push-validator.*Up"; then
            print_error "‚ùå Validator not running"
            echo "Start with: ./push-validator start"
            exit 1
        fi
        
        # Get node status
        $DOCKER_COMPOSE exec -T validator pchaind status --home /root/.pchain 2>/dev/null | jq -r '
            "Node ID: \(.node_info.id)
Network: \(.node_info.network)
Moniker: \(.node_info.moniker)
Version: \(.node_info.version)

Sync Status:
  Latest Block Height: \(.sync_info.latest_block_height)
  Latest Block Time: \(.sync_info.latest_block_time)
  Catching Up: \(.sync_info.catching_up)

Validator Info:
  Voting Power: \(.validator_info.voting_power)"
        ' || print_error "Failed to get node status. Node may still be initializing..."
        ;;
        
    logs)
        # Optional: filter by service
        SERVICE="${2:-validator}"
        TAIL="${3:-100}"
        
        print_status "üìú Showing logs for $SERVICE (last $TAIL lines)..."
        $DOCKER_COMPOSE logs -f --tail=$TAIL $SERVICE
        ;;
        
    backup)
        print_status "üíæ Creating secure backup..."
        
        # Create backup directory
        BACKUP_DIR="backups"
        mkdir -p "$BACKUP_DIR"
        
        # Run secure backup script inside container
        $DOCKER_COMPOSE exec -T validator /scripts/backup-keys.sh backup || {
            # Fallback to simple backup if new script not available
            print_warning "Using simple backup method..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            $DOCKER_COMPOSE exec -T validator tar -czf - \
                /root/.pchain/config/priv_validator_key.json \
                /root/.pchain/config/node_key.json \
                /root/.pchain/data/priv_validator_state.json 2>/dev/null \
                > "$BACKUP_DIR/validator-keys-${TIMESTAMP}.tar.gz"
            print_success "‚úÖ Backup complete: $BACKUP_DIR/validator-keys-${TIMESTAMP}.tar.gz"
        }
        
        # Also backup local config
        if [ -f .env ]; then
            cp .env "$BACKUP_DIR/.env.backup"
        fi
        ;;
        
    shell)
        print_status "üêö Opening shell in validator container..."
        $DOCKER_COMPOSE exec validator /bin/sh
        ;;
        
    reset)
        print_warning "‚ö†Ô∏è  This will delete all blockchain data!"
        read -p "Are you sure? (yes/no): " -r
        if [[ $REPLY == "yes" ]]; then
            print_status "üîÑ Resetting blockchain data..."
            $DOCKER_COMPOSE exec -T validator pchaind tendermint unsafe-reset-all
            print_success "‚úÖ Blockchain data reset"
        else
            echo "Reset cancelled"
        fi
        ;;
        
    keys)
        # Key management subcommands
        case "$2" in
            list)
                $DOCKER_COMPOSE exec -T validator pchaind keys list --keyring-backend test --home /root/.pchain
                ;;
            add)
                KEY_NAME="${3:-validator}"
                print_status "üîë Creating new key: $KEY_NAME"
                $DOCKER_COMPOSE exec validator pchaind keys add $KEY_NAME --keyring-backend test --home /root/.pchain
                ;;
            show)
                KEY_NAME="${3:-validator}"
                $DOCKER_COMPOSE exec -T validator pchaind keys show $KEY_NAME --keyring-backend test --home /root/.pchain
                ;;
            *)
                echo "Usage: ./push-validator keys {list|add|show} [key-name]"
                ;;
        esac
        ;;
        
    update)
        print_status "üîÑ Updating validator..."
        git pull
        $DOCKER_COMPOSE pull
        print_success "‚úÖ Update complete. Restart validator to apply changes."
        ;;
        
    monitor)
        # Simple monitoring view
        print_status "üìä Monitoring validator (Ctrl+C to exit)..."
        while true; do
            clear
            echo -e "${BLUE}Push Chain Validator Monitor${NC}"
            echo "============================="
            echo "Time: $(date)"
            echo ""
            
            # Get basic status
            if $DOCKER_COMPOSE exec -T validator pchaind status --home /root/.pchain 2>/dev/null | jq -r '
                "Height: \(.sync_info.latest_block_height)
Catching Up: \(.sync_info.catching_up)
Connected: true"
            '; then
                echo ""
            else
                print_error "Node not responding..."
            fi
            
            sleep 5
        done
        ;;
        
    test|health|check)
        # Run comprehensive health check tests
        if [ -f "$SCRIPT_DIR/test-validator.sh" ]; then
            print_status "üöÄ Running comprehensive health checks..."
            bash "$SCRIPT_DIR/test-validator.sh"
        else
            print_error "Test script not found!"
            exit 1
        fi
        ;;
        
    setup)
        # Interactive wallet setup and validator registration
        print_status "üöÄ Starting interactive validator setup wizard..."
        $DOCKER_COMPOSE exec -it validator /scripts/setup-validator.sh
        ;;
        
    auto-register|register)
        # Automatic registration for CI/CD deployments
        print_status "‚ö° Starting automatic validator registration..."
        
        # This command is designed for automated deployments where:
        # 1. Wallet is already created and funded
        # 2. You want minimal interaction
        
        # Check if validator wallet exists
        if ! $DOCKER_COMPOSE exec -T validator pchaind keys show validator --keyring-backend test --home /root/.pchain >/dev/null 2>&1; then
            print_error "‚ùå No 'validator' wallet found!"
            echo ""
            echo "For automated registration, you need to:"
            echo "1. First run: ./push-validator setup (to create/import wallet)"
            echo "2. Fund the wallet with at least 1.3 PUSH"
            echo "3. Then run: ./push-validator auto-register"
            echo ""
            echo "For interactive setup, use: ./push-validator setup"
            exit 1
        fi
        
        # Get current balance
        ADDRESS=$($DOCKER_COMPOSE exec -T validator pchaind keys show validator -a --keyring-backend test --home /root/.pchain 2>/dev/null | tr -d '\r')
        print_status "Using wallet: $ADDRESS"
        
        # Run auto-registration with defaults
        cat << 'EOF' | $DOCKER_COMPOSE exec -T validator /scripts/setup-validator.sh
yes
yes
Push-Validator
https://validator.push.org


1
0.1
0.2
0.01
yes
EOF
        ;;
        
    balance|wallet)
        # Check wallet balance
        WALLET_NAME="${2:-validator}"
        print_status "üí∞ Checking wallet balance..."
        
        # Get address
        ADDRESS=$($DOCKER_COMPOSE exec -T validator pchaind keys show $WALLET_NAME -a --keyring-backend test --home /root/.pchain 2>/dev/null | tr -d '\r')
        
        if [ -n "$ADDRESS" ]; then
            echo "Wallet: $WALLET_NAME"
            echo "Address: $ADDRESS"
            
            # Get balance from RPC
            BALANCE=$($DOCKER_COMPOSE exec -T validator pchaind query bank balances $ADDRESS --node tcp://localhost:26657 -o json 2>/dev/null | \
                jq -r '.balances[] | select(.denom=="upc") | .amount // "0"' || echo "0")
            
            if [ "$BALANCE" != "0" ] && [ -n "$BALANCE" ]; then
                # Convert to PUSH (divide by 10^18) using awk instead of bc
                PUSH_AMOUNT=$(awk -v bal="$BALANCE" 'BEGIN {printf "%.6f", bal/1000000000000000000}')
                print_success "Balance: $PUSH_AMOUNT PUSH"
            else
                print_warning "Balance: 0 PUSH"
                
                # Convert to EVM address for faucet
                EVM_ADDRESS=$($DOCKER_COMPOSE exec -T validator pchaind debug addr $ADDRESS 2>/dev/null | grep "hex" | awk '{print "0x"$3}')
                
                if [ -n "$EVM_ADDRESS" ]; then
                    echo
                    echo "To get test tokens:"
                    echo -e "${GREEN}1. Visit: https://faucet.push.org${NC}"
                    echo -e "${GREEN}2. Use this address: ${BOLD}$EVM_ADDRESS${NC}"
                else
                    echo "Get test tokens at: https://faucet.push.org"
                fi
            fi
        else
            print_error "Wallet '$WALLET_NAME' not found"
            echo "Run './push-validator setup' to create a wallet"
        fi
        ;;
        
    help|--help|-h)
        cat << EOF
$(echo -e "${BOLD}Push Chain Validator Manager${NC}")
$(echo -e "${BLUE}Version: 1.0.0${NC}")

Usage: ./push-validator [command] [options]

$(echo -e "${BOLD}Commands:${NC}")
  start         Start the validator node
  stop          Stop the validator node  
  restart       Restart the validator node
  status        Show validator status and sync info
  logs          Show validator logs (live tail)
  test          Run comprehensive health checks
  setup         Interactive wallet setup & validator registration wizard
  auto-register Automatic registration (requires existing funded wallet)
  balance       Check wallet balance and show faucet info
  backup        Backup validator keys to ./backup/ directory
  shell         Open shell in validator container for debugging
  reset         Reset blockchain data only (keeps wallets/keys)
  keys          Key management subcommands:
                  list              - List all wallets
                  add <name>        - Create new wallet
                  show <name>       - Show wallet address
                  delete <name>     - Delete wallet (careful!)
  update        Update validator software to latest version
  monitor       Simple monitoring view (Ctrl+C to exit)
  help          Show this help message

$(echo -e "${BOLD}Examples:${NC}")
  ./push-validator start               # Start validator
  ./push-validator start --clean       # Start with fresh blockchain data
  ./push-validator logs                # Show live validator logs
  ./push-validator logs -f             # Follow logs (same as above)
  ./push-validator logs validator 50   # Show last 50 lines
  ./push-validator test                # Run health checks
  ./push-validator setup               # Interactive setup wizard (recommended)
  ./push-validator auto-register       # Auto setup with existing wallet
  ./push-validator balance             # Check default wallet balance
  ./push-validator balance wallet2     # Check specific wallet balance
  ./push-validator keys list           # List all wallets
  ./push-validator keys add mykey      # Create new wallet named 'mykey'
  ./push-validator keys show mykey     # Show address for 'mykey'
  ./push-validator backup              # Backup validator keys
  ./push-validator reset               # Reset chain data (keeps wallets)
  ./push-validator monitor             # Watch validator status

$(echo -e "${BOLD}Network Information:${NC}")
  Chain ID:     push_42101-1
  Network:      Testnet
  RPC:          http://localhost:26657
  API:          http://localhost:1317
  Faucet:       https://faucet.push.org
  Min Stake:    1 PUSH
  
$(echo -e "${BOLD}Important Notes:${NC}")
  ‚Ä¢ Validator registration requires minimum 1 PUSH + gas fees (~0.1 PUSH)
  ‚Ä¢ The 'reset' command only clears blockchain data, wallets are preserved
  ‚Ä¢ For complete reset including wallets, use:
      docker volume rm validator_validator-data
  ‚Ä¢ Default wallet name is 'validator'
  ‚Ä¢ All keys are stored in the Docker volume for persistence
  ‚Ä¢ Backup your keys regularly using the 'backup' command

$(echo -e "${BOLD}Troubleshooting:${NC}")
  ‚Ä¢ If validator won't start: ./push-validator logs
  ‚Ä¢ If sync is stuck: ./push-validator restart
  ‚Ä¢ If balance shows 0: Check with genesis node (network might be syncing)
  ‚Ä¢ For detailed debugging: ./push-validator shell

For documentation: https://docs.push.org/validators
For support: https://discord.gg/pushprotocol
EOF
        ;;
        
    *)
        print_error "Unknown command: $1"
        echo "Run './push-validator help' for usage information"
        exit 1
        ;;
esac