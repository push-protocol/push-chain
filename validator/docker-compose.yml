services:
  validator:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BINARY_PATH=/pchaind  # Will be mounted from host
    image: push-validator:local
    container_name: push-validator
    restart: unless-stopped
    ports:
      - "26656:26656"  # P2P port
      - "26657:26657"  # RPC port
      - "1317:1317"    # REST API
      - "9090:9090"    # gRPC
      - "9091:9091"    # gRPC Web
      - "6060:6060"    # pprof (metrics)
      - "8545:8545"    # EVM JSON-RPC
      - "8546:8546"    # EVM JSON-RPC WebSocket
    volumes:
      # Mount local binary for development
      - ../build/pchaind:/usr/local/bin/pchaind:ro
      # Data directory
      - ./data:/root/.pchain
      # Scripts
      - ./scripts:/scripts:ro
      # Config files (includes genesis files)
      - ./configs:/configs:ro
    environment:
      # Basic configuration (from .env)
      - NETWORK=${NETWORK:-testnet}
      - MONIKER=${MONIKER:-MyValidator}
      - NETWORKS_CONFIG=/configs/networks.json
      
      # Optional user configuration
      - EXTERNAL_IP=${EXTERNAL_IP:-}
      - PRUNING=${PRUNING:-nothing}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Auto-configured (users don't need to change these)
      - CHAIN_ID=${CHAIN_ID:-}
      - MINIMUM_GAS_PRICES=${MINIMUM_GAS_PRICES:-}
      - AUTO_INIT=${AUTO_INIT:-true}
      - AUTO_START=${AUTO_START:-true}
      - VALIDATOR_MODE=${VALIDATOR_MODE:-true}
      - KEYRING=${KEYRING:-test}
      
    healthcheck:
      test: ["CMD", "/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
        labels: "service=push-validator"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  # Optional: Prometheus metrics exporter
  metrics:
    image: prom/node-exporter:latest
    container_name: push-metrics
    restart: unless-stopped
    ports:
      - "9100:9100"
    profiles:
      - monitoring

networks:
  default:
    name: push-validator-network